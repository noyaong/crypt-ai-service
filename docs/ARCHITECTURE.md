# 아키텍처 플로우 차트

## 전체 시스템 구조

```
┌─────────────────────────────────────────────────────────────────────────────────┐
│                           Crypto AI Analysis Service                             │
├─────────────────────────────────────────────────────────────────────────────────┤
│                                                                                  │
│  ┌──────────────┐     ┌──────────────┐     ┌──────────────┐                     │
│  │   CLI        │     │   REST API   │     │  Python SDK  │                     │
│  │  (cli.py)    │     │  (api.py)    │     │ (__init__)   │                     │
│  └──────┬───────┘     └──────┬───────┘     └──────┬───────┘                     │
│         │                    │                    │                              │
│         └────────────────────┼────────────────────┘                              │
│                              │                                                   │
│                              ▼                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                        Core Analysis Engine                                │  │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────┐   │  │
│  │  │ Transformer │  │    LSTM     │  │   Insight   │  │   LLM Insight   │   │  │
│  │  │   Model     │  │    Model    │  │  Generator  │  │   Generator     │   │  │
│  │  └─────────────┘  └─────────────┘  └─────────────┘  └─────────────────┘   │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                              │                                                   │
│                              ▼                                                   │
│  ┌───────────────────────────────────────────────────────────────────────────┐  │
│  │                         Data Sources Layer                                 │  │
│  │  ┌──────────┐ ┌──────────┐ ┌──────────────┐ ┌───────────┐ ┌────────────┐  │  │
│  │  │ Binance  │ │CoinGecko │ │Alternative.me│ │CryptoPanic│ │CoinMarketCap│ │  │
│  │  │ OHLCV    │ │ Price    │ │Fear & Greed  │ │   News    │ │   Global   │  │  │
│  │  └──────────┘ └──────────┘ └──────────────┘ └───────────┘ └────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────────┘  │
│                                                                                  │
└─────────────────────────────────────────────────────────────────────────────────┘
```

---

## 1. 모델 학습 파이프라인 (Training)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Training Pipeline                                    │
│                                                                              │
│  scripts/train_transformer.py                                                │
│                                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                   │
│  │   Binance    │    │    Data      │    │   Feature    │                   │
│  │   API Call   │───▶│  Pipeline    │───▶│  Engineering │                   │
│  │              │    │              │    │              │                   │
│  │ get_klines() │    │ fetch_data() │    │ compute_     │                   │
│  │              │    │              │    │ features()   │                   │
│  └──────────────┘    └──────────────┘    └──────────────┘                   │
│         │                   │                   │                            │
│         ▼                   ▼                   ▼                            │
│  ┌──────────────────────────────────────────────────────┐                   │
│  │                Raw OHLCV Data                        │                   │
│  │  Open, High, Low, Close, Volume (1h/4h/1d)          │                   │
│  └──────────────────────────────────────────────────────┘                   │
│                              │                                               │
│                              ▼                                               │
│  ┌──────────────────────────────────────────────────────┐                   │
│  │              Technical Indicators                     │                   │
│  │  RSI, MACD, Bollinger Bands, ATR, Returns            │                   │
│  └──────────────────────────────────────────────────────┘                   │
│                              │                                               │
│                              ▼                                               │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                   │
│  │   Dataset    │    │   Model      │    │    Save      │                   │
│  │   Creation   │───▶│   Training   │───▶│  Checkpoint  │                   │
│  │              │    │              │    │              │                   │
│  │ Sequence=60  │    │ Transformer  │    │ best.pt      │                   │
│  │ Labels       │    │ Multi-task   │    │ config.json  │                   │
│  └──────────────┘    └──────────────┘    └──────────────┘                   │
│                                                 │                            │
│                                                 ▼                            │
│                              checkpoints/transformer/{SYMBOL}/{INTERVAL}/    │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 학습 데이터 흐름

| 단계 | 입력 | 출력 | 설명 |
|------|------|------|------|
| 1. 데이터 수집 | 심볼, 기간 | Raw OHLCV | Binance API에서 캔들 데이터 수집 |
| 2. 피처 엔지니어링 | OHLCV | 9개 피처 | 기술적 지표 계산 |
| 3. 시퀀스 생성 | 피처 배열 | (N, 60, 9) | 슬라이딩 윈도우로 시퀀스 생성 |
| 4. 레이블링 | 가격 데이터 | 0/1/2 | 상승/하락/횡보 분류 |
| 5. 학습 | 데이터셋 | 모델 가중치 | Early Stopping 적용 |

---

## 2. 단일 예측 파이프라인 (Predict)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         Prediction Pipeline                                  │
│                                                                              │
│  CLI: uv run crypto-ai predict BTC --interval 1h                            │
│  API: GET /predict/BTC?interval=1h                                          │
│                                                                              │
│  ┌──────────────┐    ┌──────────────┐    ┌──────────────┐                   │
│  │   Load       │    │   Fetch      │    │   Compute    │                   │
│  │  Checkpoint  │    │  Recent Data │    │   Features   │                   │
│  │              │    │              │    │              │                   │
│  │ best.pt      │    │ Binance API  │    │ RSI, MACD    │                   │
│  │ config.json  │    │ 최근 60캔들  │    │ BB, ATR      │                   │
│  └──────────────┘    └──────────────┘    └──────────────┘                   │
│         │                   │                   │                            │
│         └───────────────────┼───────────────────┘                            │
│                             │                                                │
│                             ▼                                                │
│  ┌──────────────────────────────────────────────────────┐                   │
│  │                  Model Inference                      │                   │
│  │                                                       │                   │
│  │   Input: (1, 60, 9)  →  Transformer  →  Output       │                   │
│  │                                                       │                   │
│  │   Multi-Task Output:                                  │                   │
│  │   ├─ Direction: softmax([상승, 하락, 횡보])          │                   │
│  │   ├─ Volatility: sigmoid → 0~1                       │                   │
│  │   └─ Volume: tanh → -1~1                             │                   │
│  └──────────────────────────────────────────────────────┘                   │
│                             │                                                │
│                             ▼                                                │
│  ┌──────────────────────────────────────────────────────┐                   │
│  │                   Response                            │                   │
│  │                                                       │                   │
│  │   {                                                   │                   │
│  │     "prediction": "상승",                             │                   │
│  │     "confidence": 0.65,                               │                   │
│  │     "probabilities": {"상승": 0.65, "하락": 0.20...}, │                   │
│  │     "volatility": 0.45,                               │                   │
│  │     "volume_change": 0.12,                            │                   │
│  │     "indicators": {"rsi": 55.2, "macd": 120.5...}     │                   │
│  │   }                                                   │                   │
│  └──────────────────────────────────────────────────────┘                   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. LLM 멀티타임프레임 분석 (AI Insight)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                    LLM Multi-Timeframe Analysis Pipeline                     │
│                                                                              │
│  CLI: uv run crypto-ai insight-ai AVAX                                      │
│  API: GET /insights/ai/AVAX                                                 │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    Step 1: 멀티 타임프레임 예측                         │  │
│  │                                                                        │  │
│  │   ┌──────────┐     ┌──────────┐     ┌──────────┐                      │  │
│  │   │   1H     │     │   4H     │     │   1D     │                      │  │
│  │   │ 예측     │     │ 예측     │     │ 예측     │                      │  │
│  │   │          │     │          │     │          │                      │  │
│  │   │ 단기신호 │     │ 중기신호 │     │ 장기신호 │                      │  │
│  │   └────┬─────┘     └────┬─────┘     └────┬─────┘                      │  │
│  │        │                │                │                            │  │
│  │        └────────────────┼────────────────┘                            │  │
│  │                         ▼                                              │  │
│  │              PredictionResult × 3                                      │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                              │                                               │
│                              ▼                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    Step 2: 센티멘트 데이터 수집                         │  │
│  │                                                                        │  │
│  │   ┌──────────────┐  ┌──────────────┐  ┌──────────────┐                │  │
│  │   │Alternative.me│  │ CryptoPanic  │  │  CoinGecko   │                │  │
│  │   │              │  │              │  │              │                │  │
│  │   │Fear & Greed  │  │News Headlines│  │Social Metrics│                │  │
│  │   │  Index       │  │Bullish/Bear  │  │Community Data│                │  │
│  │   │              │  │Important/Hot │  │              │                │  │
│  │   └──────┬───────┘  └──────┬───────┘  └──────┬───────┘                │  │
│  │          │                 │                 │                         │  │
│  │          └─────────────────┼─────────────────┘                         │  │
│  │                            ▼                                           │  │
│  │                   SentimentAggregator                                  │  │
│  │                            │                                           │  │
│  │                            ▼                                           │  │
│  │  ┌─────────────────────────────────────────────────────────────────┐  │  │
│  │  │                     SentimentData                                │  │  │
│  │  │  - fear_greed_value: 72 (Greed)                                 │  │  │
│  │  │  - news_sentiment_score: +0.15                                  │  │  │
│  │  │  - news_bullish_ratio: 0.3                                      │  │  │
│  │  │  - recent_headlines: [{title, published_at, is_important}...]   │  │  │
│  │  │  - social_score: 45.2                                           │  │  │
│  │  └─────────────────────────────────────────────────────────────────┘  │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                              │                                               │
│                              ▼                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    Step 3: LLM 프롬프트 생성                           │  │
│  │                                                                        │  │
│  │   System Prompt: 암호화폐 기술적 분석 및 센티멘트 분석 전문가          │  │
│  │                                                                        │  │
│  │   User Prompt 구성:                                                    │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │   │  [심볼 정보]                                                     │ │  │
│  │   │  - 현재가: $24,567.89                                           │ │  │
│  │   │  - 24h 변동: +2.34%                                             │ │  │
│  │   │                                                                  │ │  │
│  │   │  [멀티 타임프레임 예측]                                          │ │  │
│  │   │  - 1H: 상승 (신뢰도 45.2%), RSI: 55.3, MACD: +120               │ │  │
│  │   │  - 4H: 횡보 (신뢰도 38.1%), RSI: 48.7, MACD: -50                │ │  │
│  │   │  - 1D: 상승 (신뢰도 52.3%), RSI: 62.1, MACD: +850               │ │  │
│  │   │                                                                  │ │  │
│  │   │  [센티멘트 데이터]                                               │ │  │
│  │   │  - Fear & Greed: 72 (Greed)                                     │ │  │
│  │   │  - 뉴스 센티멘트: +0.15 (중립~긍정)                              │ │  │
│  │   │  - 소셜 활성도: 45.2/100                                        │ │  │
│  │   │                                                                  │ │  │
│  │   │  [최근 뉴스 헤드라인] (GPT가 직접 분석)                          │ │  │
│  │   │  1. [2024-01-15] Bitcoin ETF sees record inflows...             │ │  │
│  │   │  2. [2024-01-15] Fed signals potential rate cuts... [HOT]       │ │  │
│  │   │  3. [2024-01-14] Major exchange adds new pairs... [IMPORTANT]   │ │  │
│  │   └─────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                              │                                               │
│                              ▼                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                    Step 4: GPT-4o-mini 분석                            │  │
│  │                                                                        │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │   │                      OpenAI API                                  │ │  │
│  │   │                                                                  │ │  │
│  │   │   model: gpt-4o-mini                                            │ │  │
│  │   │   temperature: 0.3                                              │ │  │
│  │   │   max_tokens: 1500                                              │ │  │
│  │   └─────────────────────────────────────────────────────────────────┘ │  │
│  │                              │                                        │  │
│  │                              ▼                                        │  │
│  │   ┌─────────────────────────────────────────────────────────────────┐ │  │
│  │   │                    LLM Generated Insight                        │ │  │
│  │   │                                                                  │ │  │
│  │   │   ## 종합 분석                                                   │ │  │
│  │   │   단기와 장기 모두 상승 신호, 중기는 횡보...                     │ │  │
│  │   │                                                                  │ │  │
│  │   │   ## 뉴스 분석                                                   │ │  │
│  │   │   ETF 자금 유입과 Fed 금리 인하 기대감이...                      │ │  │
│  │   │                                                                  │ │  │
│  │   │   ## 전략 제안                                                   │ │  │
│  │   │   - 단기: 풀백 시 매수 고려                                      │ │  │
│  │   │   - 중기: 관망                                                   │ │  │
│  │   │   - 장기: 상승 추세 유지 전망                                    │ │  │
│  │   └─────────────────────────────────────────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                              │                                               │
│                              ▼                                               │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                        Final Response                                  │  │
│  │                                                                        │  │
│  │   AIInsightResponse {                                                 │  │
│  │     symbol: "AVAX",                                                   │  │
│  │     predictions: [1h_result, 4h_result, 1d_result],                   │  │
│  │     sentiment: {fear_greed, news, social},                            │  │
│  │     llm_insight: "## 종합 분석\n...",                                 │  │
│  │     generated_at: "2024-01-15T12:00:00Z"                              │  │
│  │   }                                                                   │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 4. API 엔드포인트 구조

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           FastAPI Server (api.py)                            │
│                                                                              │
│  Port: 8000                                                                  │
│  Docs: /docs (Swagger UI)                                                   │
│                                                                              │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                         Endpoints                                      │  │
│  │                                                                        │  │
│  │  ┌────────────────┬────────────────────┬────────────────────────────┐ │  │
│  │  │    Endpoint    │      Handler       │        Description         │ │  │
│  │  ├────────────────┼────────────────────┼────────────────────────────┤ │  │
│  │  │ GET /health    │ health_check()     │ 서비스 상태 확인           │ │  │
│  │  ├────────────────┼────────────────────┼────────────────────────────┤ │  │
│  │  │ GET /price/    │ get_price()        │ 단일 코인 시세             │ │  │
│  │  │     {symbol}   │                    │                            │ │  │
│  │  ├────────────────┼────────────────────┼────────────────────────────┤ │  │
│  │  │ GET /prices    │ get_prices()       │ 다중 코인 시세             │ │  │
│  │  │ ?symbols=...   │                    │                            │ │  │
│  │  ├────────────────┼────────────────────┼────────────────────────────┤ │  │
│  │  │ GET /predict/  │ predict()          │ 단일 타임프레임 예측       │ │  │
│  │  │     {symbol}   │ ?interval=1h       │ Transformer/LSTM           │ │  │
│  │  │                │ ?model=transformer │                            │ │  │
│  │  ├────────────────┼────────────────────┼────────────────────────────┤ │  │
│  │  │ GET /insights/ │ get_ai_insight()   │ LLM 멀티타임프레임 분석    │ │  │
│  │  │     ai/{symbol}│                    │ + 센티멘트 + GPT 인사이트  │ │  │
│  │  ├────────────────┼────────────────────┼────────────────────────────┤ │  │
│  │  │ GET /insights/ │ get_market_insight │ 전체 시장 인사이트         │ │  │
│  │  │     market     │                    │ Fear & Greed, Top 코인     │ │  │
│  │  ├────────────────┼────────────────────┼────────────────────────────┤ │  │
│  │  │ GET /insights/ │ get_coin_insight() │ 개별 코인 인사이트         │ │  │
│  │  │     {symbol}   │                    │                            │ │  │
│  │  └────────────────┴────────────────────┴────────────────────────────┘ │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 5. 데이터 흐름 요약

```
                                   사용자 요청
                                       │
                                       ▼
                    ┌──────────────────────────────────┐
                    │     CLI / REST API / SDK         │
                    └──────────────────┬───────────────┘
                                       │
              ┌────────────────────────┼────────────────────────┐
              │                        │                        │
              ▼                        ▼                        ▼
       ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
       │   price     │         │   predict   │         │  insight-ai │
       │   market    │         │             │         │             │
       └──────┬──────┘         └──────┬──────┘         └──────┬──────┘
              │                       │                       │
              │                       │                       │
              ▼                       ▼                       ▼
       ┌─────────────┐         ┌─────────────┐         ┌─────────────┐
       │ CoinGecko   │         │ Checkpoint  │         │  Multi-TF   │
       │ CMC         │         │    Load     │         │  Predict    │
       │             │         │             │         │  (1h,4h,1d) │
       └──────┬──────┘         └──────┬──────┘         └──────┬──────┘
              │                       │                       │
              │                       ▼                       │
              │                ┌─────────────┐                │
              │                │  Binance    │                │
              │                │  OHLCV      │                │
              │                └──────┬──────┘                │
              │                       │                       │
              │                       ▼                       ▼
              │                ┌─────────────┐         ┌─────────────┐
              │                │ Transformer │         │ Sentiment   │
              │                │ Inference   │         │ Aggregator  │
              │                └──────┬──────┘         └──────┬──────┘
              │                       │                       │
              │                       │                       ▼
              │                       │              ┌─────────────────┐
              │                       │              │ Alternative.me  │
              │                       │              │ CryptoPanic     │
              │                       │              │ CoinGecko       │
              │                       │              └────────┬────────┘
              │                       │                       │
              │                       │                       ▼
              │                       │              ┌─────────────────┐
              │                       │              │   OpenAI API    │
              │                       │              │   GPT-4o-mini   │
              │                       │              └────────┬────────┘
              │                       │                       │
              ▼                       ▼                       ▼
       ┌─────────────────────────────────────────────────────────────┐
       │                        Response                              │
       │  - Price Data                                                │
       │  - Prediction (direction, confidence, volatility)           │
       │  - Sentiment (fear_greed, news, social)                     │
       │  - LLM Insight (종합 분석, 뉴스 분석, 전략 제안)            │
       └─────────────────────────────────────────────────────────────┘
```

---

## 6. 파일 의존성 다이어그램

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                            File Dependencies                                 │
│                                                                              │
│                           ┌──────────────┐                                  │
│                           │   cli.py     │                                  │
│                           │   api.py     │                                  │
│                           └──────┬───────┘                                  │
│                                  │                                          │
│         ┌────────────────────────┼────────────────────────┐                 │
│         │                        │                        │                 │
│         ▼                        ▼                        ▼                 │
│  ┌─────────────┐         ┌─────────────┐         ┌─────────────┐           │
│  │ insight.py  │         │transformer.py│        │llm_insight.py│           │
│  └──────┬──────┘         └──────┬──────┘         └──────┬──────┘           │
│         │                       │                       │                   │
│         │                       │                       │                   │
│         │                       ▼                       │                   │
│         │                ┌─────────────┐                │                   │
│         │                │preprocessing│                │                   │
│         │                │    .py      │                │                   │
│         │                └──────┬──────┘                │                   │
│         │                       │                       │                   │
│         └───────────────────────┼───────────────────────┘                   │
│                                 │                                           │
│                                 ▼                                           │
│                          ┌─────────────┐                                    │
│                          │data_sources │                                    │
│                          │    .py      │                                    │
│                          └─────────────┘                                    │
│                                 │                                           │
│            ┌────────────────────┼────────────────────┐                      │
│            │                    │                    │                      │
│            ▼                    ▼                    ▼                      │
│     ┌────────────┐      ┌────────────┐      ┌────────────┐                  │
│     │  Binance   │      │ CoinGecko  │      │Alternative │                  │
│     │   Client   │      │   Client   │      │  Client    │                  │
│     └────────────┘      └────────────┘      └────────────┘                  │
│            │                                       │                        │
│            ▼                                       │                        │
│     ┌────────────┐                                 │                        │
│     │CryptoPanic │◀────────────────────────────────┘                        │
│     │   Client   │                                                          │
│     └────────────┘                                                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 관련 문서

- [README.md](../README.md) - 프로젝트 개요 및 사용법
- [MODELS.md](MODELS.md) - AI 모델 아키텍처 상세
- [ROADMAP.md](../ROADMAP.md) - 개발 로드맵
